<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charly & Margaux - Notre Histoire d'Amour</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@600;700&family=Playfair+Display:wght@700;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase v9 SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        window.firebaseModules = { initializeApp, getDatabase, ref, set, get, onValue, push };
        window.firebaseLoaded = true;
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #FF6B9D;
            --secondary: #FFB84D;
            --accent: #9D4EDD;
            --success: #06D6A0;
            --bg-light: #FFF8F3;
            --bg-card: #FFFFFF;
            --text-dark: #2D1B2E;
            --text-light: #6B5B6E;
            --shadow-sm: 0 2px 8px rgba(255, 107, 157, 0.1);
            --shadow-md: 0 8px 24px rgba(255, 107, 157, 0.15);
            --shadow-lg: 0 16px 48px rgba(255, 107, 157, 0.2);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #FFF8F3 0%, #FFE8F0 100%);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }
        
        /* Background animation */
        .bg-shapes {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }
        
        .shape {
            position: absolute;
            opacity: 0.03;
            animation: float 20s ease-in-out infinite;
        }
        
        .shape-1 {
            top: 10%;
            left: 5%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, var(--primary) 0%, transparent 70%);
            animation-delay: 0s;
        }
        
        .shape-2 {
            top: 60%;
            right: 10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
            animation-delay: 5s;
        }
        
        .shape-3 {
            bottom: 10%;
            left: 20%;
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, var(--secondary) 0%, transparent 70%);
            animation-delay: 10s;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }
        
        /* Toast notifications - TOP RIGHT */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        
        .toast {
            background: white;
            padding: 14px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
            border-left: 4px solid var(--success);
            animation: slide-in-right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: auto;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .toast.error {
            border-left-color: #EF4444;
        }
        
        .toast.warning {
            border-left-color: var(--secondary);
        }
        
        .toast-icon {
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        
        @keyframes slide-in-right {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast.hiding {
            animation: slide-out-right 0.3s ease forwards;
        }
        
        @keyframes slide-out-right {
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        /* Sync indicator - TOP RIGHT below toasts */
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 18px;
            border-radius: 20px;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .sync-indicator.synced .sync-dot {
            background: var(--success);
        }
        
        .sync-indicator.local .sync-dot {
            background: var(--secondary);
        }
        
        .sync-indicator.error .sync-dot {
            background: #EF4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        /* Header */
        header {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: 80px 20px 60px;
        }
        
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(3rem, 10vw, 6rem);
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
            letter-spacing: -0.02em;
            animation: title-appear 0.8s cubic-bezier(0.4, 0, 0.2, 1) backwards;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        h1:hover {
            transform: scale(1.02);
        }
        
        @keyframes title-appear {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
        }
        
        .subtitle {
            font-family: 'Caveat', cursive;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: var(--text-light);
            font-weight: 600;
            animation: subtitle-appear 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.2s backwards;
        }
        
        @keyframes subtitle-appear {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
        }
        
        /* Container */
        .container {
            position: relative;
            z-index: 10;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px 100px;
        }
        
        /* Grid */
        .memories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 32px;
            margin-top: 40px;
        }
        
        /* Memory Card */
        .memory-card {
            background: var(--bg-card);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: card-appear 0.6s cubic-bezier(0.4, 0, 0.2, 1) backwards;
            position: relative;
        }
        
        .memory-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 24px;
            padding: 3px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .memory-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }
        
        .memory-card:hover::before {
            opacity: 1;
        }
        
        .memory-card:nth-child(1) { animation-delay: 0.1s; }
        .memory-card:nth-child(2) { animation-delay: 0.15s; }
        .memory-card:nth-child(3) { animation-delay: 0.2s; }
        .memory-card:nth-child(4) { animation-delay: 0.25s; }
        .memory-card:nth-child(5) { animation-delay: 0.3s; }
        .memory-card:nth-child(6) { animation-delay: 0.35s; }
        
        @keyframes card-appear {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
        }
        
        .card-number {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Playfair Display', serif;
            font-weight: 900;
            font-size: 1.25rem;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
        }
        
        .card-image {
            width: 100%;
            height: 240px;
            background: linear-gradient(135deg, #FFE8F0 0%, #E8F5FF 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .memory-card:hover .card-image img {
            transform: scale(1.08);
        }
        
        .image-placeholder {
            font-size: 4rem;
            opacity: 0.3;
        }
        
        .card-content {
            padding: 24px;
        }
        
        .card-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 12px;
        }
        
        .card-text {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-dark);
            margin-bottom: 20px;
            min-height: 60px;
        }
        
        .card-button {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .card-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 157, 0.3);
        }
        
        .card-button:active {
            transform: translateY(0);
        }
        
        /* FAB Buttons */
        .fab-container {
            position: fixed;
            bottom: 32px;
            right: 32px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            z-index: 1000;
        }
        
        .fab {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            font-size: 1.75rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fab-appear 0.5s cubic-bezier(0.4, 0, 0.2, 1) backwards;
        }
        
        .fab:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 12px 32px rgba(255, 107, 157, 0.4);
        }
        
        .fab:active {
            transform: scale(1.05) rotate(5deg);
        }
        
        .fab-settings {
            background: linear-gradient(135deg, var(--secondary), #FFD700);
            animation-delay: 0.1s;
        }
        
        .fab-add {
            animation-delay: 0.2s;
        }
        
        @keyframes fab-appear {
            from {
                opacity: 0;
                transform: translateY(100px) scale(0);
            }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(45, 27, 46, 0.7);
            backdrop-filter: blur(12px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: modal-bg-appear 0.3s ease;
        }
        
        .modal.active {
            display: flex;
        }
        
        @keyframes modal-bg-appear {
            from { opacity: 0; }
        }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 24px 64px rgba(0,0,0,0.3);
            animation: modal-content-appear 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes modal-content-appear {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(40px);
            }
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--bg-light);
            color: var(--text-dark);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background: var(--primary);
            color: white;
            transform: rotate(90deg);
        }
        
        .modal h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 900;
            color: var(--text-dark);
            margin-bottom: 32px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-dark);
            margin-bottom: 8px;
        }
        
        .form-input,
        .form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #F0F0F0;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: var(--bg-light);
            border: 2px dashed #E0E0E0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .file-label:hover {
            border-color: var(--primary);
            background: rgba(255, 107, 157, 0.05);
        }
        
        .file-name {
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--success);
            font-weight: 500;
        }
        
        .btn-primary {
            width: 100%;
            padding: 16px 32px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 8px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(255, 107, 157, 0.3);
        }
        
        .btn-secondary {
            width: 100%;
            padding: 16px 32px;
            background: white;
            color: var(--text-dark);
            border: 2px solid #E0E0E0;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
        }
        
        .btn-secondary:hover {
            border-color: var(--primary);
            background: rgba(255, 107, 157, 0.05);
        }
        
        .info-box {
            background: linear-gradient(135deg, rgba(6, 214, 160, 0.1), rgba(168, 216, 255, 0.1));
            padding: 20px;
            border-radius: 12px;
            margin-top: 24px;
            border-left: 4px solid var(--success);
        }
        
        .info-box strong {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dark);
        }
        
        .info-box p {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-light);
            margin: 6px 0;
        }
        
        .code-snippet {
            background: #1a1a1a;
            color: #00ff00;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin: 12px 0;
            overflow-x: auto;
        }
        
        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 107, 157, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9998;
            align-items: center;
            justify-content: center;
        }
        
        .spinner-overlay.active {
            display: flex;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            header {
                padding: 60px 20px 40px;
            }
            
            h1 {
                font-size: 3rem;
            }
            
            .subtitle {
                font-size: 1.5rem;
            }
            
            .memories-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .fab-container {
                bottom: 24px;
                right: 24px;
            }
            
            .fab {
                width: 56px;
                height: 56px;
            }
            
            .modal-content {
                padding: 32px 24px;
            }
            
            .sync-indicator {
                top: 12px;
                right: 12px;
                font-size: 0.8rem;
                padding: 8px 14px;
            }
            
            .toast-container {
                top: 12px;
                right: 12px;
                left: 12px;
            }
            
            .toast {
                min-width: unset;
            }
        }
        
        /* Smooth scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), var(--accent));
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- Background shapes -->
    <div class="bg-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>
    
    <!-- Sync indicator -->
    <div class="sync-indicator local" id="syncIndicator">
        <div class="sync-dot"></div>
        <span id="syncText">Chargement...</span>
    </div>
    
    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Spinner overlay -->
    <div class="spinner-overlay" id="spinnerOverlay">
        <div class="spinner"></div>
    </div>
    
    <!-- Header -->
    <header>
        <h1 onclick="handleTitleClick()">Charly & Margaux</h1>
        <p class="subtitle">Notre histoire d'amour en images ‚ù§Ô∏è</p>
    </header>
    
    <!-- Main content -->
    <div class="container">
        <div class="memories-grid" id="memoriesGrid">
            <!-- Memory cards will be inserted here -->
        </div>
    </div>
    
    <!-- FAB Buttons -->
    <div class="fab-container">
        <button class="fab fab-settings" onclick="openSettingsModal()" title="Configuration Firebase">
            ‚öôÔ∏è
        </button>
        <button class="fab fab-add" onclick="openAddMemoryModal()" title="Ajouter un souvenir">
            +
        </button>
    </div>
    
    <!-- Edit Memory Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('editModal')">√ó</button>
            <h2>‚ú® Modifier ce souvenir</h2>
            <form id="editForm" onsubmit="saveMemory(event)">
                <div class="form-group">
                    <label class="form-label">üìù Votre message</label>
                    <textarea 
                        id="noteInput" 
                        class="form-textarea" 
                        placeholder="Racontez ce moment sp√©cial..."
                        required
                    ></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üì∏ Ajouter une photo</label>
                    <input 
                        type="file" 
                        id="photoInput" 
                        class="file-input" 
                        accept="image/*"
                        onchange="handlePhotoChange()"
                    >
                    <label for="photoInput" class="file-label">
                        <span>üìÅ</span>
                        <span>Choisir une photo</span>
                    </label>
                    <div id="fileName" class="file-name"></div>
                </div>
                
                <button type="submit" class="btn-primary">üíæ Sauvegarder</button>
            </form>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('settingsModal')">√ó</button>
            <h2>‚öôÔ∏è Configuration Firebase</h2>
            
            <div class="info-box">
                <strong>üìö Configuration rapide :</strong>
                <p>1. Cr√©ez un projet sur <a href="https://console.firebase.google.com" target="_blank" style="color: var(--primary); font-weight: 600;">Firebase Console</a></p>
                <p>2. Activez "Realtime Database" en mode test</p>
                <p>3. V√©rifiez que les r√®gles sont :</p>
                <div class="code-snippet">{
  "rules": {
    ".read": true,
    ".write": true
  }
}</div>
                <p>4. Copiez votre configuration Web ci-dessous</p>
            </div>
            
            <form id="settingsForm" onsubmit="saveFirebaseConfig(event)">
                <div class="form-group">
                    <label class="form-label">üîë API Key</label>
                    <input 
                        type="text" 
                        id="apiKeyInput" 
                        class="form-input" 
                        placeholder="AIza..."
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label">üåê Database URL</label>
                    <input 
                        type="text" 
                        id="databaseUrlInput" 
                        class="form-input" 
                        placeholder="https://...firebaseio.com"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label">üì¶ Project ID</label>
                    <input 
                        type="text" 
                        id="projectIdInput" 
                        class="form-input" 
                        placeholder="mon-projet-123"
                        required
                    >
                </div>
                
                <button type="submit" class="btn-primary">‚úÖ Sauvegarder et activer</button>
                <button type="button" class="btn-secondary" onclick="testFirebaseConnection()">
                    üß™ Tester la connexion
                </button>
            </form>
        </div>
    </div>
    
    <script>
        // ============================================
        // GLOBAL STATE
        // ============================================
        let memories = [];
        let currentEditIndex = -1;
        let firebaseApp = null;
        let firebaseDb = null;
        let isFirebaseReady = false;
        let titleClickCount = 0;
        let isSaving = false;
        
        // ============================================
        // FIREBASE INITIALIZATION
        // ============================================
        async function initializeFirebase() {
            const configStr = localStorage.getItem('firebaseConfig');
            
            if (!configStr) {
                console.log('No Firebase config found');
                updateSyncStatus('local', 'Local uniquement');
                return false;
            }
            
            try {
                showSpinner(true);
                const config = JSON.parse(configStr);
                
                // Wait for Firebase SDK
                await waitForFirebaseSDK();
                
                const { initializeApp, getDatabase, ref, onValue } = window.firebaseModules;
                
                // Initialize Firebase
                if (!firebaseApp) {
                    firebaseApp = initializeApp(config);
                }
                firebaseDb = getDatabase(firebaseApp);
                isFirebaseReady = true;
                
                console.log('‚úÖ Firebase initialized successfully');
                updateSyncStatus('synced', 'Cloud synchronis√©');
                
                // Setup real-time listener
                setupRealtimeListener();
                
                showToast('Firebase connect√© !', 'success');
                showSpinner(false);
                return true;
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                showToast('Erreur Firebase: ' + error.message, 'error');
                updateSyncStatus('error', 'Erreur connexion');
                showSpinner(false);
                return false;
            }
        }
        
        function waitForFirebaseSDK() {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (window.firebaseLoaded && window.firebaseModules) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 50);
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve();
                }, 10000);
            });
        }
        
        function setupRealtimeListener() {
            if (!isFirebaseReady || !firebaseDb) return;
            
            try {
                const { ref, onValue } = window.firebaseModules;
                const memoriesRef = ref(firebaseDb, 'memories');
                
                onValue(memoriesRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        
                        // Only update if data is different
                        if (JSON.stringify(data) !== JSON.stringify(memories)) {
                            console.log('üîÑ Real-time update received');
                            memories = data;
                            renderMemories();
                            saveToLocalStorage();
                            showToast('Donn√©es synchronis√©es !', 'success');
                        }
                    }
                }, (error) => {
                    console.error('Listener error:', error);
                });
                
                console.log('üëÇ Real-time sync active');
            } catch (error) {
                console.error('Listener setup error:', error);
            }
        }
        
        // ============================================
        // DATA MANAGEMENT
        // ============================================
        async function loadMemories() {
            console.log('üìÇ Loading memories...');
            
            // Try Firebase first if configured
            if (isFirebaseReady && firebaseDb) {
                try {
                    const { ref, get } = window.firebaseModules;
                    const memoriesRef = ref(firebaseDb, 'memories');
                    const snapshot = await get(memoriesRef);
                    
                    if (snapshot.exists()) {
                        memories = snapshot.val();
                        console.log('‚úÖ Loaded from Firebase:', memories.length);
                        saveToLocalStorage();
                        return;
                    }
                } catch (error) {
                    console.error('Firebase load error:', error);
                }
            }
            
            // Fallback to localStorage
            const saved = localStorage.getItem('memories');
            if (saved) {
                try {
                    memories = JSON.parse(saved);
                    console.log('‚úÖ Loaded from localStorage:', memories.length);
                    
                    // Sync to Firebase if available
                    if (isFirebaseReady) {
                        await saveToFirebase();
                    }
                } catch (error) {
                    console.error('LocalStorage parse error:', error);
                    createDefaultMemories();
                }
            } else {
                createDefaultMemories();
            }
        }
        
        function createDefaultMemories() {
            console.log('üÜï Creating default memories');
            memories = [];
            for (let i = 0; i < 6; i++) {
                memories.push({
                    note: `Clique sur "Modifier" pour ajouter ton souvenir sp√©cial ici ! üíñ`,
                    photo: null,
                    createdAt: new Date().toISOString()
                });
            }
            saveMemories();
        }
        
        async function saveMemories() {
            if (isSaving) {
                console.log('‚è∏Ô∏è Save already in progress');
                return;
            }
            
            isSaving = true;
            console.log('üíæ Saving memories...');
            
            // Always save to localStorage first (immediate)
            saveToLocalStorage();
            
            // Then save to Firebase (prioritized)
            if (isFirebaseReady && firebaseDb) {
                try {
                    await saveToFirebase();
                    showToast('Sauvegard√© sur le cloud ‚òÅÔ∏è', 'success');
                } catch (error) {
                    console.error('Firebase save error:', error);
                    showToast('Sauvegarde locale uniquement', 'warning');
                }
            } else {
                showToast('Sauvegarde locale uniquement', 'warning');
            }
            
            isSaving = false;
        }
        
        function saveToLocalStorage() {
            try {
                localStorage.setItem('memories', JSON.stringify(memories));
                localStorage.setItem('memories_backup', JSON.stringify(memories));
                localStorage.setItem('memories_timestamp', new Date().toISOString());
                console.log('‚úÖ Saved to localStorage');
                return true;
            } catch (error) {
                console.error('LocalStorage save error:', error);
                return false;
            }
        }
        
        async function saveToFirebase() {
            if (!isFirebaseReady || !firebaseDb) {
                throw new Error('Firebase not ready');
            }
            
            try {
                const { ref, set } = window.firebaseModules;
                const memoriesRef = ref(firebaseDb, 'memories');
                await set(memoriesRef, memories);
                console.log('‚úÖ Saved to Firebase');
                return true;
            } catch (error) {
                console.error('Firebase save error:', error);
                throw error;
            }
        }
        
        // ============================================
        // UI RENDERING
        // ============================================
        function renderMemories() {
            const grid = document.getElementById('memoriesGrid');
            grid.innerHTML = '';
            
            memories.forEach((memory, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                
                const imageHtml = memory.photo 
                    ? `<img src="${memory.photo}" alt="Souvenir ${index + 1}">` 
                    : `<div class="image-placeholder">üì∑</div>`;
                
                card.innerHTML = `
                    <div class="card-number">${index + 1}</div>
                    <div class="card-image">${imageHtml}</div>
                    <div class="card-content">
                        <div class="card-label">üíå Notre moment</div>
                        <div class="card-text">${memory.note}</div>
                        <button class="card-button" onclick="openEditMemoryModal(${index})">
                            <span>‚úèÔ∏è</span>
                            <span>Modifier</span>
                        </button>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        function updateSyncStatus(status, text) {
            const indicator = document.getElementById('syncIndicator');
            const textEl = document.getElementById('syncText');
            
            indicator.className = `sync-indicator ${status}`;
            textEl.textContent = text;
        }
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || '‚úÖ'}</span>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function showSpinner(show) {
            const overlay = document.getElementById('spinnerOverlay');
            overlay.classList.toggle('active', show);
        }
        
        // ============================================
        // MEMORY OPERATIONS
        // ============================================
        function openEditMemoryModal(index) {
            currentEditIndex = index;
            document.getElementById('noteInput').value = memories[index].note;
            document.getElementById('fileName').textContent = '';
            document.getElementById('photoInput').value = '';
            document.getElementById('editModal').classList.add('active');
        }
        
        function openAddMemoryModal() {
            memories.push({
                note: 'Notre nouveau souvenir...',
                photo: null,
                createdAt: new Date().toISOString()
            });
            openEditMemoryModal(memories.length - 1);
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'editModal') {
                currentEditIndex = -1;
            }
        }
        
        function handlePhotoChange() {
            const input = document.getElementById('photoInput');
            const fileNameEl = document.getElementById('fileName');
            
            if (input.files && input.files[0]) {
                fileNameEl.textContent = `‚úì ${input.files[0].name}`;
            }
        }
        
        async function saveMemory(event) {
            event.preventDefault();
            
            if (currentEditIndex === -1) return;
            
            showSpinner(true);
            
            const note = document.getElementById('noteInput').value;
            const photoFile = document.getElementById('photoInput').files[0];
            
            // Update note
            memories[currentEditIndex].note = note;
            memories[currentEditIndex].updatedAt = new Date().toISOString();
            
            // Handle photo if provided
            if (photoFile) {
                try {
                    const compressed = await compressImage(photoFile);
                    memories[currentEditIndex].photo = compressed;
                } catch (error) {
                    console.error('Image compression error:', error);
                    showToast('Erreur traitement image', 'error');
                    showSpinner(false);
                    return;
                }
            }
            
            // Save
            await saveMemories();
            
            // Update UI
            renderMemories();
            closeModal('editModal');
            showSpinner(false);
        }
        
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const img = new Image();
                    
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Resize to max 1200px
                        const maxSize = 1200;
                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = (height / width) * maxSize;
                                width = maxSize;
                            } else {
                                width = (width / height) * maxSize;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressed = canvas.toDataURL('image/jpeg', 0.8);
                        console.log('üì∏ Image compressed:', Math.round(compressed.length / 1024), 'KB');
                        resolve(compressed);
                    };
                    
                    img.onerror = () => reject(new Error('Image load failed'));
                    img.src = e.target.result;
                };
                
                reader.onerror = () => reject(new Error('File read failed'));
                reader.readAsDataURL(file);
            });
        }
        
        // ============================================
        // FIREBASE SETTINGS
        // ============================================
        function openSettingsModal() {
            const config = localStorage.getItem('firebaseConfig');
            
            if (config) {
                const cfg = JSON.parse(config);
                document.getElementById('apiKeyInput').value = cfg.apiKey || '';
                document.getElementById('databaseUrlInput').value = cfg.databaseURL || '';
                document.getElementById('projectIdInput').value = cfg.projectId || '';
            }
            
            document.getElementById('settingsModal').classList.add('active');
        }
        
        async function saveFirebaseConfig(event) {
            event.preventDefault();
            
            const config = {
                apiKey: document.getElementById('apiKeyInput').value.trim(),
                databaseURL: document.getElementById('databaseUrlInput').value.trim(),
                projectId: document.getElementById('projectIdInput').value.trim(),
                authDomain: document.getElementById('projectIdInput').value.trim() + '.firebaseapp.com',
                storageBucket: document.getElementById('projectIdInput').value.trim() + '.appspot.com'
            };
            
            localStorage.setItem('firebaseConfig', JSON.stringify(config));
            showToast('Configuration sauvegard√©e ! Rechargement...', 'success');
            
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        }
        
        async function testFirebaseConnection() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const databaseURL = document.getElementById('databaseUrlInput').value.trim();
            const projectId = document.getElementById('projectIdInput').value.trim();
            
            if (!apiKey || !databaseURL || !projectId) {
                showToast('Remplis tous les champs !', 'error');
                return;
            }
            
            showToast('Test en cours...', 'warning');
            
            try {
                await waitForFirebaseSDK();
                const { initializeApp, getDatabase, ref, get } = window.firebaseModules;
                
                const testConfig = {
                    apiKey,
                    databaseURL,
                    projectId,
                    authDomain: projectId + '.firebaseapp.com',
                    storageBucket: projectId + '.appspot.com'
                };
                
                const testApp = initializeApp(testConfig, 'test-' + Date.now());
                const testDb = getDatabase(testApp);
                const testRef = ref(testDb, '.info/connected');
                
                await get(testRef);
                showToast('‚úÖ Connexion r√©ussie !', 'success');
                
            } catch (error) {
                console.error('Test error:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // ============================================
        // FUN INTERACTIONS
        // ============================================
        function handleTitleClick() {
            titleClickCount++;
            
            if (titleClickCount === 3) {
                showToast('Je t\'aime Charly ! üíï‚ú®', 'success');
                titleClickCount = 0;
            }
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        async function initialize() {
            console.log('üöÄ Initializing app...');
            
            // Initialize Firebase
            await initializeFirebase();
            
            // Load memories
            await loadMemories();
            
            // Render UI
            renderMemories();
            
            // Auto-save every 30 seconds
            setInterval(async () => {
                if (memories.length > 0 && !isSaving) {
                    console.log('‚è∞ Auto-save triggered');
                    await saveMemories();
                }
            }, 30000);
            
            console.log('‚úÖ App ready!');
        }
        
        // Close modals on background click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
        
        // Start app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
